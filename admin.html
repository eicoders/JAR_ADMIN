<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADMIN - Jar Scheduler</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <style>
        :root { --color-primary: #FF5733; --color-bg-deep: #000; --color-bg-card: #222; --color-text: #fff; }
        body { font-family: 'Inter', sans-serif; background-color: var(--color-bg-deep); color: var(--color-text); padding: 1rem; }
        .container { max-width: 600px; margin: 0 auto; }
        .card { background-color: var(--color-bg-card); padding: 1.5rem; border-radius: 16px; margin-bottom: 1.5rem; border: 1px solid #333; }
        .input-field { background-color: #111; border: 1px solid #444; color: white; padding: 0.75rem; border-radius: 8px; width: 100%; margin-top: 5px; }
        
        .btn { padding: 0.75rem 1.5rem; border-radius: 10px; font-weight: 700; width: 100%; margin-top: 1rem; cursor: pointer; transition: 0.2s; }
        .btn-primary { background-color: var(--color-primary); color: white; border: none; }
        
        .member-item { display: flex; align-items: center; padding: 0.75rem; background-color: #333; margin-bottom: 0.5rem; border-radius: 8px; gap: 10px; cursor: grab; }
        .member-item.dragging { opacity: 0.5; border: 1px dashed var(--color-primary); background: #222; }
        .del-btn { background: #b91c1c; color: #fff; border: none; padding: 5px 12px; border-radius: 4px; font-weight: bold; font-size: 1.2rem; }
        .grip-icon { color: #666; font-size: 1.2rem; user-select: none; }

        /* Toggle Switch Style */
        .toggle-checkbox:checked { right: 0; border-color: #ef4444; }
        .toggle-checkbox:checked + .toggle-label { background-color: #ef4444; }

        /* Login Screen Styles */
        #login-view {
            height: 90vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
    </style>
</head>
<body>

    <div id="login-view">
        <h1 class="text-4xl font-bold text-red-500 mb-2">Jar Admin Panel</h1>
        <p class="text-gray-400 mb-8">Secure Access Required</p>
        
        <button onclick="adminLogin()" class="btn bg-white text-black hover:bg-gray-200" style="width: auto; display: flex; align-items: center; gap: 10px;">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20">
            Login with Google
        </button>
    </div>

    <div id="dashboard-view" style="display: none;" class="container">
        
        <div class="flex justify-between items-center mb-6 border-b border-gray-800 pb-4">
            <div>
                <h1 class="text-2xl font-bold text-red-500">Dashboard</h1>
                <p class="text-xs text-gray-500 mt-1">UID: <span id="user-uid" class="text-yellow-500 select-all">...</span></p>
            </div>
            <button onclick="adminLogout()" class="text-sm bg-gray-800 px-3 py-1 rounded hover:bg-red-900 text-white transition">Logout</button>
        </div>
        
        <div class="card">
            <h2 class="text-xl font-semibold mb-4">Scheduler Settings</h2>
            
            <label class="block text-sm text-gray-400">Days Per Turn:</label>
            <input type="number" id="days-per-turn" class="input-field" placeholder="No Of Days">
            
            <label class="block text-sm text-gray-400 mt-4">Cycle Start Date:</label>
            <input type="text" id="start-date" class="input-field" placeholder="Enter start date" onfocus="(this.type='date')" onblur="(this.value ? this.type='date' : this.type='text')">

            <h3 class="text-md font-medium mt-6 mb-2">Member List</h3>
            <div id="members-list"></div>
            
            <button onclick="addMemberInput()" class="btn" style="background-color: #444;">+ Add Member</button>
            <button id="save-btn" class="btn btn-primary">Save Settings</button>
            <p id="settings-msg" class="text-center mt-2 text-sm text-green-400"></p>
        </div>

        <div class="card" style="border: 1px solid #ef4444;">
            <h2 class="text-xl font-semibold mb-4 text-red-500">Global Alert / Alert Mode</h2>
            <p class="text-xs text-gray-400 mb-2">When ON, this message will hide the website content.</p>
            
            <div class="flex items-center justify-between mb-4 bg-gray-900 p-3 rounded-lg">
                <span class="text-white font-medium">Show Alert Screen?</span>
                <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                    <input type="checkbox" name="toggle" id="alert-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                    <label for="alert-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-600 cursor-pointer"></label>
                </div>
            </div>

            <label class="block text-sm text-gray-400">Alert Message:</label>
            <textarea id="alert-message" rows="3" class="input-field" placeholder="Example: Site is under maintenance. Please wait..."></textarea>
            
            <button id="save-alert-btn" class="btn bg-red-600 hover:bg-red-700 text-white">Update Live Alert</button>
            <p id="alert-msg" class="text-center mt-2 text-sm text-green-400"></p>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCG9w-pUJq9FopmIUUPLUVMc03P84Rblgw",
            authDomain: "jar-ledger.firebaseapp.com",
            databaseURL: "https://jar-ledger-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "jar-ledger",
            storageBucket: "jar-ledger.firebasestorage.app",
            messagingSenderId: "915159281904",
            appId: "1:915159281904:web:4f3d5c940a03c4b525d235",
            measurementId: "G-YB740FJBBG"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        const settingsRef = db.ref('borewell_settings');
        const alertRef = db.ref('site_alert');

        // --- AUTH & VIEW LOGIC ---
        const loginView = document.getElementById('login-view');
        const dashboardView = document.getElementById('dashboard-view');

        function adminLogin() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch(e => alert(e.message));
        }

        function adminLogout() {
            auth.signOut();
        }

        auth.onAuthStateChanged(user => {
            if (user) {
                // USER LOGGED IN: Show Dashboard, Hide Login
                loginView.style.display = 'none';
                dashboardView.style.display = 'block';
                document.getElementById('user-uid').innerText = user.uid;
                loadData(); // Load data only after login
            } else {
                // USER LOGGED OUT: Show Login, Hide Dashboard
                loginView.style.display = 'flex';
                dashboardView.style.display = 'none';
            }
        });

        // --- DATA LOADING (Moved inside function) ---
        function loadData() {
            // Load Scheduler
            settingsRef.once('value').then((snapshot) => {
                const data = snapshot.val();
                if (data) {
                    document.getElementById('days-per-turn').value = data.daysPerTurn || '';
                    document.getElementById('start-date').value = data.startDate || '';
                    if (data.startDate) document.getElementById('start-date').type = 'date';
                    
                    document.getElementById('members-list').innerHTML = ''; // Clear existing
                    if(data.members) data.members.forEach(name => addMemberInput(name));
                    else addMemberInput();
                } else {
                    if(document.getElementById('members-list').children.length === 0) addMemberInput();
                }
            });

            // Load Alert
            alertRef.once('value').then((snapshot) => {
                const data = snapshot.val();
                if (data) {
                    document.getElementById('alert-toggle').checked = data.isActive || false;
                    document.getElementById('alert-message').value = data.message || '';
                }
            });
        }

        // --- DRAG & DROP LOGIC ---
        let draggedItem = null;
        function handleDragStart(e) {
            draggedItem = this;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
            setTimeout(() => this.classList.add('dragging'), 0);
        }
        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            const target = e.target.closest('.member-item');
            if (target && target !== draggedItem) {
                const rect = target.getBoundingClientRect();
                const next = (e.clientY - rect.top) / rect.height > 0.5;
                const parent = target.parentNode;
                if (next) parent.insertBefore(draggedItem, target.nextSibling);
                else parent.insertBefore(draggedItem, target);
            }
        }
        function handleDragEnd() { this.classList.remove('dragging'); draggedItem = null; }

        function addMemberInput(val = '') {
            const list = document.getElementById('members-list');
            const div = document.createElement('div');
            div.className = 'member-item';
            div.setAttribute('draggable', 'true');
            div.addEventListener('dragstart', handleDragStart);
            div.addEventListener('dragover', handleDragOver);
            div.addEventListener('dragend', handleDragEnd);
            div.innerHTML = `<span class="grip-icon">☰</span><input type="text" value="${val}" class="input-field" style="margin:0; border:none;" placeholder="Name"><button onclick="this.parentElement.remove()" class="del-btn">×</button>`;
            list.appendChild(div);
        }

        // --- SAVE FUNCTIONS ---
        document.getElementById('save-btn').addEventListener('click', () => {
            if (!auth.currentUser) return alert("Please Login First!");
            
            const days = parseInt(document.getElementById('days-per-turn').value);
            const start = document.getElementById('start-date').value;
            const inputs = document.querySelectorAll('.member-item input[type="text"]');
            const members = Array.from(inputs).map(i => i.value.trim()).filter(i => i);
            
            if (!days || !start || members.length === 0) return alert("Please fill all fields");

            settingsRef.set({ daysPerTurn: days, startDate: start, members: members })
                .then(() => {
                    const msg = document.getElementById('settings-msg');
                    msg.textContent = "Settings Saved!";
                    setTimeout(() => msg.textContent = '', 3000);
                })
                .catch(e => alert("Error: " + e.message + "\n(Check Security Rules)"));
        });

        document.getElementById('save-alert-btn').addEventListener('click', () => {
            if (!auth.currentUser) return alert("Please Login First!");

            const isActive = document.getElementById('alert-toggle').checked;
            const message = document.getElementById('alert-message').value;

            alertRef.set({ isActive: isActive, message: message })
                .then(() => {
                    const msg = document.getElementById('alert-msg');
                    msg.textContent = "Alert Status Updated Live!";
                    setTimeout(() => msg.textContent = '', 3000);
                })
                .catch(e => alert("Error: " + e.message + "\n(Check Security Rules)"));
        });
    </script>
</body>
</html>